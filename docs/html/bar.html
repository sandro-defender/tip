
<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        fetch("/includes/head.html")
            .then(response => response.text())
            .then(data => document.head.innerHTML += data)
            .catch(error => console.error("Error loading head:", error));
    </script>
    <title>áƒ¡áƒ˜áƒ’áƒáƒ áƒ”áƒ¢áƒ˜áƒ¡ áƒ˜áƒœáƒ•áƒ”áƒœáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒšáƒ™áƒ£áƒšáƒáƒ¢áƒáƒ áƒ˜</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Imports */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Theme Variables */
        :root {
            /* Light Theme */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #06b6d4;
            --text: #1f2937;
            --text-secondary: #4b5563;
            --background: #f9fafb;
            --surface: #ffffff;
            --surface-secondary: #f3f4f6;
            --border: #e5e7eb;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                      0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --secondary: #0ea5e9;
            --text: #f9fafb;
            --text-secondary: #d1d5db;
            --background: #111827;
            --surface: #1f2937;
            --surface-secondary: #374151;
            --border: #374151;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 
                      0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --success: #059669;
            --error: #dc2626;
            --warning: #d97706;
            --info: #2563eb;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0 0 110px 0;
            background-color: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Calculator Container */
        .calculator {
            max-width: 450px;
            margin: 40px auto;
            padding: 24px;
            border-radius: 12px;
            background-color: var(--surface);
            box-shadow: var(--shadow);
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
            text-align: center;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text);
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--surface-secondary);
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s ease;
            outline: none;
        }

        .input-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        button {
            padding: 12px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-calculate {
            background-color: var(--success);
        }

        .btn-calculate:hover:not(:disabled) {
            background-color: var(--success);
            filter: brightness(1.1);
        }

        .btn-print {
            background-color: var(--info);
        }

        .btn-print:hover {
            background-color: var(--info);
            filter: brightness(1.1);
        }

        .btn-messenger {
            background-color: #0084ff;
        }

        .btn-messenger:hover {
            background-color: #0084ff;
            filter: brightness(1.1);
        }

        .btn-reset {
            background-color: var(--error);
        }

        .btn-reset:hover {
            background-color: var(--error);
            filter: brightness(1.1);
        }

        .btn-copy {
            background-color: var(--text-secondary);
        }

        .btn-copy:hover {
            background-color: var(--text-secondary);
            filter: brightness(1.1);
        }

        .btn-history {
            background-color: var(--warning);
            grid-column: 1 / -1;
        }

        .btn-history:hover {
            background-color: var(--warning);
            filter: brightness(1.1);
        }

        /* History Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--surface);
            padding: 24px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background-color: var(--surface-secondary);
            color: var(--text);
            transform: none;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .history-item {
            background-color: var(--surface-secondary);
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            transition: all 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .history-item.success {
            border-left-color: var(--success);
        }

        .history-item.positive {
            border-left-color: var(--info);
        }

        .history-item.negative {
            border-left-color: var(--error);
        }

        .history-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .history-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.875rem;
        }

        .history-detail {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .history-detail-label {
            color: var(--text-secondary);
        }

        .history-detail-value {
            font-weight: 600;
            color: var(--text);
        }

        .history-status {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .history-status.success {
            background-color: var(--success);
            color: white;
        }

        .history-status.positive {
            background-color: var(--info);
            color: white;
        }

        .history-status.negative {
            background-color: var(--error);
            color: white;
        }

        .no-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-history i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading-history .loading {
            width: 32px;
            height: 32px;
            border-width: 3px;
            margin: 0 auto 16px;
        }

        /* Share container styling */
        .share-container {
            margin-top: 24px;
            padding: 20px;
            background-color: var(--surface-secondary);
            border-radius: 12px;
            animation: fadeIn 0.5s ease;
        }

        .share-title {
            text-align: center;
            margin-bottom: 16px;
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 500;
        }

        .share-options {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }

        .share-options button {
            width: auto;
            height: 48px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 24px;
            font-size: 1rem;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .share-options button:hover {
            transform: translateY(-3px);
        }

        /* Copy notification */
        .copy-notification {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            animation: slideDown 0.3s ease forwards;
            opacity: 1;
            transition: opacity 0.3s ease;
            z-index: 100;
        }

        @keyframes slideDown {
            from { top: -50px; }
            to { top: -10px; }
        }

        #result {
            margin-top: 24px;
            display: none;
            color: var(--text);
            background-color: var(--surface-secondary);
            border-radius: 8px;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #result.visible {
            display: block;
        }

        #result .input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border);
        }

        #result .input-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        #result .input-group label {
            margin-bottom: 0;
            font-weight: 400;
        }

        #result .input-group span {
            color: var(--text);
            font-weight: 600;
        }

        #difference {
            margin-top: 16px;
        }

        .difference {
            color: var(--text);
            font-weight: 600;
            text-align: center;
            padding: 12px 16px;
            background-color: var(--surface);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .difference.success {
            background-color: var(--success);
            color: white;
        }

        .difference.positive {
            background-color: var(--info);
            color: white;
        }

        .difference.negative {
            background-color: var(--error);
            color: white;
        }

        #timestamp {
            margin-top: 12px;
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
        }

        .theme-toggle {
            display: none;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status message */
        .status-message {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .status-message.success {
            background-color: var(--success);
            color: white;
        }

        .status-message.error {
            background-color: var(--error);
            color: white;
        }


        /* Responsive adjustments */
        @media (max-width: 500px) {
            .calculator {
                margin: 20px 16px;
                padding: 20px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="menu-container"></div>
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">ğŸŒ™</button>
    <div class="calculator">
        <h2>áƒ˜áƒœáƒ•áƒ”áƒœáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒšáƒ™áƒ£áƒšáƒáƒ¢áƒáƒ áƒ˜</h2>
        


        <div class="shop">
            <h3>áƒ‘áƒáƒ áƒ˜áƒ¡ áƒ˜áƒœáƒ•áƒ”áƒœáƒ¢áƒáƒ áƒ˜</h3>
            <div class="input-group">
                <label for="total1">áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜:</label>
                <input type="number" id="total1" placeholder="áƒ©áƒáƒáƒ•áƒ˜áƒ‘áƒáƒ áƒ”" min="0"
                       inputmode="numeric" pattern="[0-9]*"
                       onkeypress="return event.charCode >= 48">
            </div>
            <div class="input-group">
                <label for="received1">áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡:</label>
                <input type="number" id="received1" placeholder="áƒ›áƒ˜áƒ•áƒ˜áƒ¦áƒ”" min="0"
                       inputmode="numeric" pattern="[0-9]*"
                       onkeypress="return event.charCode >= 48">
            </div>
            <div class="input-group">
                <label for="reprints1">áƒ’áƒáƒ§áƒ˜áƒ“áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡:</label>
                <input type="number" id="reprints1" placeholder="áƒ’áƒáƒ˜áƒ§áƒ˜áƒ“áƒ" min="0"
                       inputmode="numeric" pattern="[0-9]*"
                       onkeypress="return event.charCode >= 48">
            </div>
            <div class="input-group">
                <label for="endDay1">áƒ¡áƒáƒ‘áƒáƒšáƒáƒ áƒ›áƒáƒ áƒáƒ’áƒ˜:</label>
                <input type="number" id="endDay1" placeholder="áƒ“áƒáƒ áƒ©áƒ" min="0"
                       inputmode="numeric" pattern="[0-9]*"
                       onkeypress="return event.charCode >= 48">
            </div>
        </div>

        <div class="button-group">
            <button onclick="calculate()" class="btn-calculate" id="calculateBtn">
                <span>áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ</span>
            </button>
            <button onclick="resetForm()" class="btn-reset">
                <span>áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ</span>
            </button>
            <button onclick="loadHistory()" class="btn-history">
                <i class="fas fa-history"></i>
                <span>áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</span>
            </button>
        </div>

        <div id="statusMessage"></div>

        <div class="share-container" id="action-buttons" style="display: none;">
            <h3 class="share-title">áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒ</h3>

            <div class="button-group">
                <button onclick="printResults()" class="btn-print">
                    <i class="fas fa-print"></i>
                    <span>áƒ“áƒáƒ‘áƒ”áƒ­áƒ“áƒ•áƒ</span>
                </button>
                <button onclick="copyToClipboard()" class="btn-copy">
                    <i class="fas fa-copy"></i>
                    <span>áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ</span>
                </button>
            </div>

            <div class="share-options">
                <button onclick="shareToMessenger()" class="btn-messenger">
                    <i class="fab fa-facebook-messenger"></i>
                    <span>Messenger</span>
                </button>
                <button onclick="shareResults()" class="btn-share" id="shareButton">
                    <i class="fas fa-share-alt"></i>
                    <span>áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒ</span>
                </button>
            </div>
        </div>

        <div id="result"></div>
        <div id="difference"></div>
        <div id="timestamp"></div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-history"></i> áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ</h2>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div id="historyContent">
                <div class="loading-history">
                    <div class="loading"></div>
                    <p>áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Constants and State
        const DOM = {
            result: document.getElementById('result'),
            difference: document.getElementById('difference'),
            timestamp: document.getElementById('timestamp'),
            actionButtons: document.getElementById('action-buttons'),
            statusMessage: document.getElementById('statusMessage'),
            calculateBtn: document.getElementById('calculateBtn'),
            historyModal: document.getElementById('historyModal'),
            historyContent: document.getElementById('historyContent')
        };

        const WORKER_API_URL = (function resolveWorkerUrl() {
            if (window.BAR_WORKER_URL) {
                return window.BAR_WORKER_URL.replace(/\/+$/, '');
            }

            const host = window.location.hostname;
            if (host === 'localhost' || host === '127.0.0.1') {
                return 'http://127.0.0.1:8787';
            }

            return 'https://bar-api.sandro-1990.workers.dev';
        })();

        const getHistoryEndpoint = () => WORKER_API_URL.includes('?')
            ? `${WORKER_API_URL}&action=getHistory`
            : `${WORKER_API_URL}?action=getHistory`;
        const STATE = {
            lastCalculationData: null,
            historySaved: false,
            savingPromise: null
        };

        const ThemeManager = (() => {
            const STORAGE_KEY = 'theme';

            const detectDeviceTheme = () => {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                }
                return 'light';
            };

            const getStoredTheme = () => localStorage.getItem(STORAGE_KEY) || 'auto';

            const getEffectiveTheme = (theme) => theme === 'auto' ? detectDeviceTheme() : theme;

            const updateToggleButton = (theme) => {
                const themeToggle = document.getElementById('themeToggle');
                if (!themeToggle) return;

                if (theme === 'auto') {
                    themeToggle.textContent = 'ğŸ“²';
                    themeToggle.setAttribute('aria-label', 'Switch to light mode');
                } else if (theme === 'light') {
                    themeToggle.textContent = 'ğŸŒ';
                    themeToggle.setAttribute('aria-label', 'Switch to dark mode');
                } else {
                    themeToggle.textContent = 'ğŸŒ™';
                    themeToggle.setAttribute('aria-label', 'Switch to auto mode');
                }
            };

            const applyTheme = (theme, { save = true } = {}) => {
                const effectiveTheme = getEffectiveTheme(theme);
                document.body.setAttribute('data-theme', effectiveTheme);
                if (save) {
                    localStorage.setItem(STORAGE_KEY, theme);
                }
                updateToggleButton(theme);
                if (DOM.result.classList.contains('visible')) {
                    applyThemeToResults();
                }
            };

            const cycleTheme = () => {
                const current = getStoredTheme();
                const next = current === 'auto' ? 'light' : (current === 'light' ? 'dark' : 'auto');
                applyTheme(next);
            };

            const handleSystemThemeChange = () => {
                if (getStoredTheme() === 'auto') {
                    applyTheme('auto', { save: false });
                }
            };

            const setupSystemThemeListeners = () => {
                if (!window.matchMedia) return;
                const queries = ['(prefers-color-scheme: dark)', '(prefers-color-scheme: light)'];
                queries.forEach(query => {
                    const mediaQuery = window.matchMedia(query);
                    if (mediaQuery.addEventListener) {
                        mediaQuery.addEventListener('change', handleSystemThemeChange);
                    } else if (mediaQuery.addListener) {
                        mediaQuery.addListener(handleSystemThemeChange);
                    }
                });
            };

            const init = () => {
                applyTheme(getStoredTheme(), { save: false });
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle && !themeToggle.dataset.themeBound) {
                    themeToggle.addEventListener('click', cycleTheme);
                    themeToggle.dataset.themeBound = 'true';
                }
                setupSystemThemeListeners();
            };

            return { init, applyTheme };
        })();

        // áƒ›áƒ”áƒœáƒ˜áƒ£áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ
        fetch('/includes/menu.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('menu-container').innerHTML = data;
            })
            .catch(error => console.error('Error loading menu:', error));

        // Theme Management
        document.addEventListener('DOMContentLoaded', () => {
            ThemeManager.init();
            DOM.actionButtons.style.display = 'none';
        });

        function applyThemeToResults() {
            if (!DOM.result || !DOM.difference || !DOM.timestamp) return;

            DOM.result.style.backgroundColor = 'var(--surface)';
            DOM.result.style.color = 'var(--text)';
            DOM.result.style.borderColor = 'var(--border)';

            const errorMessage = DOM.result.querySelector('div[style*="background-color: var(--error)"]');
            if (errorMessage) {
                errorMessage.style.backgroundColor = 'var(--error)';
                errorMessage.style.color = 'white';
            }

            DOM.difference.style.color = 'var(--text)';
            DOM.timestamp.style.color = 'var(--text)';

            const labels = DOM.result.querySelectorAll('label');
            const spans = DOM.result.querySelectorAll('span');

            labels.forEach(label => {
                label.style.color = 'var(--text)';
            });

            spans.forEach(span => {
                span.style.color = 'var(--text)';
            });
        }

        function showStatus(message, type = 'success') {
            DOM.statusMessage.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            setTimeout(() => {
                DOM.statusMessage.innerHTML = '';
            }, 3000);
        }

        function triggerHistorySave() {
            if (!STATE.lastCalculationData || STATE.historySaved) {
                return;
            }

            if (STATE.savingPromise) {
                return;
            }

            STATE.savingPromise = (async () => {
                const result = await saveCalculationToWorker(STATE.lastCalculationData);

                if (result.success) {
                    STATE.historySaved = true;
                    if (!result.skipped) {
                        showStatus('âœ… áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ Cloudflare D1-áƒ¨áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ', 'success');
                    }
                } else {
                    showStatus(`âš ï¸ ${result.error || 'áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ, áƒ¡áƒªáƒáƒ“áƒ”áƒ— áƒ®áƒ”áƒšáƒáƒ®áƒšáƒ'}`, 'error');
                }

                STATE.savingPromise = null;
            })();
        }

        async function saveCalculationToWorker(data) {
            const workerUrl = WORKER_API_URL?.trim();

            if (!workerUrl) {
                console.warn('Cloudflare Worker URL not configured - skipping save');
                return { success: true, skipped: true };
            }

            try {
                DOM.calculateBtn.disabled = true;
                DOM.calculateBtn.innerHTML = '<div class="loading"></div><span>áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ...</span>';

                const response = await fetch(workerUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(errorBody || `Request failed with status ${response.status}`);
                }

                const payload = await response.json().catch(() => ({ result: 'success' }));
                if (payload.result !== 'success') {
                    throw new Error(payload.error || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ Cloudflare Worker-áƒ“áƒáƒœ');
                }

                return { success: true };
            } catch (error) {
                console.error('Error saving to Cloudflare Worker:', error);
                return { success: false, error: error.message };
            } finally {
                DOM.calculateBtn.disabled = false;
                DOM.calculateBtn.innerHTML = '<span>áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ</span>';
            }
        }

        async function calculate() {
            DOM.actionButtons.style.display = 'none';

            var total1 = parseInt(document.getElementById('total1').value);
            var received1 = parseInt(document.getElementById('received1').value);
            var reprints1 = parseInt(document.getElementById('reprints1').value);
            var endDay1 = parseInt(document.getElementById('endDay1').value);

            if (isNaN(total1) || isNaN(received1) || isNaN(reprints1) || isNaN(endDay1) ||
                total1 < 0 || received1 < 0 || reprints1 < 0 || endDay1 < 0) {
                DOM.result.innerHTML = `
                    <div style="padding: 16px; background-color: var(--error); color: white; border-radius: 8px; text-align: center;">
                        áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒáƒ— áƒ¡áƒ¬áƒáƒ áƒ˜ áƒ áƒ˜áƒªáƒ®áƒ•áƒ”áƒ‘áƒ˜ áƒ§áƒ•áƒ”áƒšáƒ áƒ•áƒ”áƒšáƒ¨áƒ˜. áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ˜áƒ—áƒ˜ áƒ áƒ˜áƒªáƒ®áƒ•áƒ”áƒ‘áƒ˜ áƒ“áƒáƒ£áƒ¨áƒ•áƒ”áƒ‘áƒ”áƒšáƒ˜áƒ.
                    </div>
                `;
                DOM.result.classList.add('visible');
                DOM.difference.innerText = "";
                DOM.timestamp.innerText = "";
                DOM.actionButtons.style.display = 'none';
                return;
            }

            var remaining1 = total1 + received1 - reprints1;
            var difference1 = endDay1 - remaining1;
            var timestamp = new Date().toISOString();

            // Prepare data for Google Sheets
            const sheetData = {
                timestamp: timestamp,
                date: new Date().toLocaleDateString('ka-GE'),
                time: new Date().toLocaleTimeString('ka-GE'),
                initialStock: total1,
                received: received1,
                sold: reprints1,
                finalStock: endDay1,
                expectedStock: remaining1,
                difference: difference1,
                status: difference1 === 0 ? 'áƒ˜áƒ“áƒ”áƒáƒšáƒ£áƒ áƒ˜' : (difference1 > 0 ? 'áƒ›áƒ”áƒ¢áƒáƒ‘áƒ' : 'áƒ“áƒáƒœáƒáƒ™áƒšáƒ˜áƒ¡áƒ˜')
            };

            STATE.lastCalculationData = sheetData;
            STATE.historySaved = false;
            STATE.savingPromise = null;

            // Display results
            DOM.result.innerHTML = `
                <h3>áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ˜áƒ¡ áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜:</h3>
                <div class="input-group">
                    <label>áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜:</label>
                    <span>${total1}</span>
                </div>
                <div class="input-group">
                    <label>áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡:</label>
                    <span>${received1}</span>
                </div>
                <div class="input-group">
                    <label>áƒ’áƒáƒ§áƒ˜áƒ“áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡:</label>
                    <span>${reprints1}</span>
                </div>
                <div class="input-group">
                    <label>áƒ¡áƒáƒ‘áƒáƒšáƒáƒ áƒ›áƒáƒ áƒáƒ’áƒ˜:</label>
                    <span>${endDay1}</span>
                </div>
                <div class="input-group">
                    <label>áƒ›áƒáƒ¡áƒáƒšáƒáƒ“áƒœáƒ”áƒšáƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜:</label>
                    <span>${remaining1}</span>
                </div>
            `;

            const differenceClass = difference1 === 0 ? 'success' : (difference1 > 0 ? 'positive' : 'negative');
            let differenceText = '';

            if (difference1 === 0) {
                differenceText = 'áƒ˜áƒ“áƒ”áƒáƒšáƒ£áƒ áƒ˜ áƒ“áƒáƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒ!';
            } else if (difference1 > 0) {
                differenceText = `áƒ›áƒ”áƒ¢áƒáƒ‘áƒ: +${difference1} (áƒ›áƒ”áƒ¢áƒ˜áƒ áƒ•áƒ˜áƒ“áƒ áƒ” áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡)`;
            } else {
                differenceText = `áƒ“áƒáƒœáƒáƒ™áƒšáƒ˜áƒ¡áƒ˜: ${difference1} (áƒœáƒáƒ™áƒšáƒ”áƒ‘áƒ˜áƒ áƒ•áƒ˜áƒ“áƒ áƒ” áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡)`;
            }

            DOM.difference.innerHTML = `
                <div class="difference ${differenceClass}">${differenceText}</div>
            `;

            DOM.result.classList.add('visible');
            DOM.timestamp.innerText = `áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ áƒ¨áƒ”áƒ¡áƒ áƒ£áƒšáƒ“áƒ: ${new Date(timestamp).toLocaleString('ka-GE')}`;

            applyThemeToResults();
            DOM.actionButtons.style.display = 'block';
            DOM.actionButtons.style.animation = 'fadeIn 0.5s ease';
            DOM.actionButtons.style.position = 'relative';
            DOM.result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function printResults() {
            if (!DOM.result.classList.contains('visible')) {
                alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¯áƒ”áƒ  áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒšáƒáƒ— áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜ áƒ“áƒáƒ‘áƒ”áƒ­áƒ“áƒ•áƒáƒ›áƒ“áƒ”.');
                return;
            }

            triggerHistorySave();

            var resultElement = DOM.result;
            var differenceElement = DOM.difference;
            var timestampElement = DOM.timestamp;

            var resultValues = {};
            var labels = resultElement.querySelectorAll('.input-group label');
            var spans = resultElement.querySelectorAll('.input-group span');

            labels.forEach((label, index) => {
                var labelText = label.textContent.replace(':', '');
                var valueText = spans[index].textContent;
                resultValues[labelText] = valueText;
            });

            var differenceText = '';
            if (differenceElement.querySelector('.difference')) {
                differenceText = differenceElement.querySelector('.difference').textContent;
            }

            var timestampText = timestampElement.innerText;

            var printDiv = document.createElement('div');
            printDiv.id = 'print-only-content';
            printDiv.style.display = 'none';

            printDiv.innerHTML = `
                <div class="print-results">
                    <div class="print-result-item">
                        <span class="print-result-label">áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜:</span>
                        <span class="print-result-value">${resultValues['áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜']}</span>
                    </div>
                    <div class="print-result-item">
                        <span class="print-result-label">áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡:</span>
                        <span class="print-result-value">${resultValues['áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡']}</span>
                    </div>
                    <div class="print-result-item">
                        <span class="print-result-label">áƒ’áƒáƒ§áƒ˜áƒ“áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡:</span>
                        <span class="print-result-value">${resultValues['áƒ’áƒáƒ§áƒ˜áƒ“áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡']}</span>
                    </div>
                    <div class="print-result-item">
                        <span class="print-result-label">áƒ¡áƒáƒ‘áƒáƒšáƒáƒ áƒ›áƒáƒ áƒáƒ’áƒ˜:</span>
                        <span class="print-result-value">${resultValues['áƒ¡áƒáƒ‘áƒáƒšáƒáƒ áƒ›áƒáƒ áƒáƒ’áƒ˜']}</span>
                    </div>
                    <div class="print-result-item">
                        <span class="print-result-label">áƒ›áƒáƒ¡áƒáƒšáƒáƒ“áƒœáƒ”áƒšáƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜:</span>
                        <span class="print-result-value">${resultValues['áƒ›áƒáƒ¡áƒáƒšáƒáƒ“áƒœáƒ”áƒšáƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜']}</span>
                    </div>
                    <div class="print-difference">${differenceText}</div>
                    <div class="print-timestamp">${timestampText}</div>
                </div>
            `;

            document.body.appendChild(printDiv);

            var printStyleSheet = document.createElement('style');
            printStyleSheet.id = 'print-styles';
            printStyleSheet.textContent = `
                @media print {
                    body * {
                        visibility: hidden;
                    }
                    #print-only-content,
                    #print-only-content * {
                        visibility: visible;
                    }
                    #print-only-content {
                        position: absolute;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        display: block !important;
                        background-color: white;
                        color: black;
                        padding: 20px;
                    }
                    .print-results {
                        border: 1px solid #000;
                        padding: 15px;
                        max-width: 400px;
                        margin: 0 auto;
                        page-break-inside: avoid;
                    }
                    .print-result-item {
                        margin-bottom: 8px;
                        border-bottom: 1px dotted #000;
                        padding-bottom: 5px;
                        display: flex;
                        justify-content: space-between;
                    }
                    .print-result-label {
                        font-weight: normal;
                    }
                    .print-result-value {
                        font-weight: bold;
                    }
                    .print-difference {
                        margin-top: 16px;
                        font-weight: bold;
                        text-align: center;
                        border: 1px solid #000;
                        padding: 8px;
                    }
                    .print-timestamp {
                        margin-top: 12px;
                        font-style: italic;
                        font-size: 0.75rem;
                        text-align: center;
                    }
                }
            `;

            document.head.appendChild(printStyleSheet);

            setTimeout(function() {
                window.print();

                setTimeout(function() {
                    document.body.removeChild(printDiv);
                    document.head.removeChild(printStyleSheet);
                }, 1000);
            }, 200);
        }

        function formatResultsForSharing() {
            if (!DOM.result.classList.contains('visible')) {
                return null;
            }

            const title = "ğŸ“‹ áƒ¡áƒ˜áƒ’áƒáƒ áƒ”áƒ¢áƒ˜áƒ¡ áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜ ğŸ“‹\n";
            const divider = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";

            const resultElement = DOM.result;
            const spans = resultElement.querySelectorAll('.input-group span');
            const labels = resultElement.querySelectorAll('.input-group label');

            let formattedResultText = '';
            spans.forEach((span, index) => {
                const label = labels[index].textContent.replace(':', '');
                const value = span.textContent.trim();

                if (label.includes('áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜')) {
                    formattedResultText += `ğŸ”¹ ${label}: ${value}\n`;
                } else if (label.includes('áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡')) {
                    formattedResultText += `â• ${label}: ${value}\n`;
                } else if (label.includes('áƒ’áƒáƒ§áƒ˜áƒ“áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ¡')) {
                    formattedResultText += `â– ${label}: ${value}\n`;
                } else if (label.includes('áƒ¡áƒáƒ‘áƒáƒšáƒáƒ áƒ›áƒáƒ áƒáƒ’áƒ˜')) {
                    formattedResultText += `ğŸ”¸ ${label}: ${value}\n`;
                } else if (label.includes('áƒ›áƒáƒ¡áƒáƒšáƒáƒ“áƒœáƒ”áƒšáƒ˜ áƒ›áƒáƒ áƒáƒ’áƒ˜')) {
                    formattedResultText += `âœ… ${label}: ${value}\n`;
                }
            });

            let differenceText = DOM.difference.querySelector('.difference').textContent;
            if (differenceText.includes('áƒ˜áƒ“áƒ”áƒáƒšáƒ£áƒ áƒ˜ áƒ“áƒáƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒ')) {
                differenceText = 'ğŸ¯ ' + differenceText;
            } else if (differenceText.includes('áƒ›áƒ”áƒ¢áƒáƒ‘áƒ')) {
                differenceText = 'ğŸ“ˆ ' + differenceText;
            } else if (differenceText.includes('áƒ“áƒáƒœáƒáƒ™áƒšáƒ˜áƒ¡áƒ˜')) {
                differenceText = 'ğŸ“‰ ' + differenceText;
            }

            const timestampText = 'â±ï¸ ' + DOM.timestamp.innerText;

            return {
                title,
                divider,
                formattedResultText,
                differenceText,
                timestampText,
                getFullMessage(includeMarkdown = false) {
                    const titleText = includeMarkdown ? `*${this.title.trim()}*` : this.title;
                    return `${titleText}\n${this.divider}${this.formattedResultText}\n${this.differenceText}\n\n${this.timestampText}`;
                }
            };
        }

        function getMessengerShareLink(message) {
            const encodedMessage = encodeURIComponent(message);
            return `https://m.me/?text=${encodedMessage}`;
        }

        function isMessengerWebView() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            return /FBAN|FBAV|FB_IAB|FBAN\/Messenger/i.test(ua);
        }

        function shareToMessenger() {
            const formattedData = formatResultsForSharing();
            if (!formattedData) {
                alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¯áƒ”áƒ  áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒšáƒáƒ— áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜ áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒáƒ›áƒ“áƒ”.');
                return;
            }

            triggerHistorySave();

            const message = formattedData.getFullMessage();
            
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = message;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const shareContainer = DOM.actionButtons;
                    const notification = document.createElement('div');
                    notification.className = 'copy-notification';
                    notification.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 8px;">ğŸ“‹ áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜ áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ“áƒ!</div>
                            <div style="font-size: 0.9rem;">Messenger-áƒ¨áƒ˜ áƒ©áƒáƒ¡áƒ•áƒ˜áƒ— áƒ“áƒ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ”áƒ—</div>
                        </div>
                    `;
                    shareContainer.appendChild(notification);

                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => shareContainer.removeChild(notification), 300);
                    }, 4000);

                    const messengerUrl = 'https://m.me/';
                    window.open(messengerUrl, '_blank', 'noopener,noreferrer');
                } else {
                    alert('áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ. áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ®áƒ”áƒšáƒ˜áƒ— áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒáƒ— áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜.');
                }
            } catch (err) {
                console.error('áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:', err);
                alert('áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ. áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ®áƒ”áƒšáƒ˜áƒ— áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒáƒ— áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜.');
            }

            document.body.removeChild(tempTextarea);
        }

        async function shareResults() {
            const formattedData = formatResultsForSharing();
            if (!formattedData) {
                alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¯áƒ”áƒ  áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒšáƒáƒ— áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜ áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒáƒ›áƒ“áƒ”.');
                return;
            }

            triggerHistorySave();

            if (isMessengerWebView()) {
                copyToClipboard();
                alert('Messenger-áƒ¨áƒ˜ áƒ©áƒáƒ¨áƒ”áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ˜ áƒ‘áƒšáƒáƒ™áƒáƒ•áƒ¡ áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒáƒ¡. áƒ’áƒáƒ®áƒ¡áƒ”áƒœáƒ˜áƒ— áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜ áƒ’áƒáƒ áƒ” áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ¨áƒ˜ áƒ“áƒ áƒªáƒáƒ“áƒ”áƒ— áƒ®áƒ”áƒšáƒáƒ®áƒšáƒ, áƒáƒœ áƒ©áƒáƒ¡áƒ•áƒ˜áƒ— áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜ áƒ©áƒáƒ¢áƒ¨áƒ˜.');
                return;
            }

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'áƒ¡áƒ˜áƒ’áƒáƒ áƒ”áƒ¢áƒ˜áƒ¡ áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜',
                        text: formattedData.getFullMessage()
                    });
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error sharing:', err);
                        alert('áƒ’áƒáƒ–áƒ˜áƒáƒ áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ');
                    }
                }
            }

            copyToClipboard();
        }

        function copyToClipboard() {
            const formattedData = formatResultsForSharing();
            if (!formattedData) {
                alert('áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ¯áƒ”áƒ  áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒšáƒáƒ— áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜ áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒáƒ›áƒ“áƒ”.');
                return;
            }

            triggerHistorySave();

            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = formattedData.getFullMessage();
            document.body.appendChild(tempTextarea);
            tempTextarea.select();

            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜ áƒ“áƒáƒ™áƒáƒáƒ˜áƒ áƒ“áƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—!' : 'áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ';

                const shareContainer = DOM.actionButtons;
                const notification = document.createElement('div');
                notification.className = 'copy-notification';
                notification.textContent = msg;
                shareContainer.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => shareContainer.removeChild(notification), 300);
                }, 2000);
            } catch (err) {
                console.error('áƒ™áƒáƒáƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:', err);
            }

            document.body.removeChild(tempTextarea);
        }

        function resetForm() {
            document.getElementById('total1').value = '';
            document.getElementById('received1').value = '';
            document.getElementById('reprints1').value = '';
            document.getElementById('endDay1').value = '';

            DOM.result.classList.remove('visible');
            DOM.difference.innerHTML = '';
            DOM.timestamp.innerText = '';
            DOM.statusMessage.innerHTML = '';

            DOM.actionButtons.style.display = 'none';

            document.getElementById('total1').focus();

            STATE.lastCalculationData = null;
            STATE.historySaved = false;
            STATE.savingPromise = null;
        }

        async function loadHistory() {
            const workerUrl = WORKER_API_URL?.trim();
            
            if (!workerUrl) {
                alert('Cloudflare Worker URL áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜.');
                return;
            }

            // Ensure we request the history action
            const historyUrl = getHistoryEndpoint();

            // Show modal
            DOM.historyModal.classList.add('visible');
            DOM.historyContent.innerHTML = `
                <div class="loading-history">
                    <div class="loading"></div>
                    <p>áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
                </div>
            `;

            try {
                const response = await fetch(historyUrl, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch history');
                }

                const data = await response.json();
                
                if (data.result === 'success' && data.history && data.history.length > 0) {
                    displayHistory(data.history);
                } else {
                    DOM.historyContent.innerHTML = `
                        <div class="no-history">
                            <i class="fas fa-inbox"></i>
                            <p>áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ áƒ¯áƒ”áƒ  áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ</p>
                            <p style="font-size: 0.875rem; margin-top: 8px;">áƒ“áƒáƒ˜áƒ¬áƒ§áƒ”áƒ— áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ˜áƒ¡áƒ˜áƒœáƒ˜ áƒáƒ¥ áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ‘áƒ</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading history:', error);
                DOM.historyContent.innerHTML = `
                    <div class="no-history">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ</p>
                        <p style="font-size: 0.875rem; margin-top: 8px;">áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ“áƒ˜áƒ—, áƒ áƒáƒ› Cloudflare Worker áƒ“áƒ D1 áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ—áƒ áƒ‘áƒáƒ–áƒ áƒ¡áƒ¬áƒáƒ áƒáƒ“ áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒœáƒ¤áƒ˜áƒ’áƒ£áƒ áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜</p>
                    </div>
                `;
            }
        }

        function displayHistory(history) {
            history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const uniqueHistory = [];
            const seenDates = new Set();

            history.forEach(item => {
                const dateKey = new Date(item.timestamp).toISOString().split('T')[0];
                if (!seenDates.has(dateKey)) {
                    uniqueHistory.push(item);
                    seenDates.add(dateKey);
                }
            });

            const PAGE_SIZE = 10;
            let currentCount = 0;

            const renderItems = () => {
                const list = document.createElement('div');
                list.className = 'history-list';

                const itemsToRender = uniqueHistory.slice(0, currentCount);
                if (itemsToRender.length === 0) {
                    DOM.historyContent.innerHTML = `
                        <div class="no-history">
                            <i class="fas fa-inbox"></i>
                            <p>áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ áƒ¯áƒ”áƒ  áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ</p>
                            <p style="font-size: 0.875rem; margin-top: 8px;">áƒ“áƒáƒ˜áƒ¬áƒ§áƒ”áƒ— áƒ’áƒáƒ›áƒáƒ—áƒ•áƒšáƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ˜áƒ¡áƒ˜áƒœáƒ˜ áƒáƒ¥ áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ‘áƒ</p>
                        </div>
                    `;
                    return;
                }

                itemsToRender.forEach(item => {
                    const statusClass = item.difference === 0 ? 'success' : (item.difference > 0 ? 'positive' : 'negative');
                    const statusText = item.status || (item.difference === 0 ? 'áƒ˜áƒ“áƒ”áƒáƒšáƒ£áƒ áƒ˜' : (item.difference > 0 ? 'áƒ›áƒ”áƒ¢áƒáƒ‘áƒ' : 'áƒ“áƒáƒœáƒáƒ™áƒšáƒ˜áƒ¡áƒ˜'));
                    
                    const date = new Date(item.timestamp);
                    const formattedDate = date.toLocaleDateString('ka-GE', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const formattedTime = date.toLocaleTimeString('ka-GE', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });

                    list.innerHTML += `
                        <div class="history-item ${statusClass}">
                            <div class="history-date">
                                <i class="far fa-calendar"></i> ${formattedDate} â€¢ 
                                <i class="far fa-clock"></i> ${formattedTime}
                            </div>
                            <div class="history-details">
                                <div class="history-detail">
                                    <span class="history-detail-label">áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜:</span>
                                    <span class="history-detail-value">${item.initialStock}</span>
                                </div>
                                <div class="history-detail">
                                    <span class="history-detail-label">áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ£áƒšáƒ˜:</span>
                                    <span class="history-detail-value">+${item.received}</span>
                                </div>
                                <div class="history-detail">
                                    <span class="history-detail-label">áƒ’áƒáƒ§áƒ˜áƒ“áƒ£áƒšáƒ˜:</span>
                                    <span class="history-detail-value">-${item.sold}</span>
                                </div>
                                <div class="history-detail">
                                    <span class="history-detail-label">áƒ¡áƒáƒ‘áƒáƒšáƒáƒ:</span>
                                    <span class="history-detail-value">${item.finalStock}</span>
                                </div>
                                <div class="history-detail">
                                    <span class="history-detail-label">áƒ›áƒáƒ¡áƒáƒšáƒáƒ“áƒœáƒ”áƒšáƒ˜:</span>
                                    <span class="history-detail-value">${item.expectedStock}</span>
                                </div>
                                <div class="history-detail">
                                    <span class="history-detail-label">áƒ¡áƒ®áƒ•áƒáƒáƒ‘áƒ:</span>
                                    <span class="history-detail-value">${item.difference > 0 ? '+' : ''}${item.difference}</span>
                                </div>
                            </div>
                            <div class="history-status ${statusClass}">
                                ${statusText === 'áƒ˜áƒ“áƒ”áƒáƒšáƒ£áƒ áƒ˜' ? 'ğŸ¯' : (statusText === 'áƒ›áƒ”áƒ¢áƒáƒ‘áƒ' ? 'ğŸ“ˆ' : 'ğŸ“‰')} ${statusText}
                            </div>
                        </div>
                    `;
                });

                DOM.historyContent.innerHTML = '';
                DOM.historyContent.appendChild(list);

                if (currentCount < uniqueHistory.length) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.textContent = 'áƒ›áƒ”áƒ¢áƒ˜áƒ¡ áƒœáƒáƒ®áƒ•áƒ';
                    loadMoreBtn.style.marginTop = '20px';
                    loadMoreBtn.style.width = '100%';
                    loadMoreBtn.className = 'btn-history';
                    loadMoreBtn.onclick = () => {
                        currentCount = Math.min(currentCount + PAGE_SIZE, uniqueHistory.length);
                        renderItems();
                    };
                    DOM.historyContent.appendChild(loadMoreBtn);
                }
            };

            currentCount = Math.min(PAGE_SIZE, uniqueHistory.length);
            renderItems();
        }

        function closeHistoryModal() {
            DOM.historyModal.classList.remove('visible');
        }

        // Close modal when clicking outside
        DOM.historyModal.addEventListener('click', function(event) {
            if (event.target === DOM.historyModal) {
                closeHistoryModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && DOM.historyModal.classList.contains('visible')) {
                closeHistoryModal();
            }
        });

        
    </script>

</body>
</html>

<!-- --- Changelog ---
2025-11-17: Switched storage to Cloudflare D1 worker endpoint. (auto) -->
