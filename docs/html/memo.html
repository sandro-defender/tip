<!--
Project: Staff.You Memo
File: html/memo/memo.html
Version: 1.4.3
Author: Cursor AI
Model: GPT-5
Last Modified: 2025-10-17
Purpose: Modern memo UI with drag-drop upload, previews, dark mode, and menu include
-->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memo Blog</title>
  <!-- TailwindCSS CDN for modern utility-first styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config for dark mode via class
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    /*
      Keep minimal custom CSS for non-inline styles per project rules.
      Drag & drop visual states and hidden input utility
    */
    .drag-over {
      background: rgba(59,130,246,0.06);
      outline: 2px dashed rgba(59,130,246,0.55);
      outline-offset: 0;
    }
    .drag-over-dark {
      background: rgba(59,130,246,0.10);
      outline: 2px dashed rgba(147,197,253,0.55);
    }
    .visually-hidden { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <!-- Top bar with title and dark mode toggle -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 dark:bg-gray-900/70 border-b border-gray-200/70 dark:border-gray-800">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-semibold tracking-tight">Memo Blog</h1>
      <div class="flex items-center gap-3">
        <button id="newMemoToggle" class="px-3 py-1.5 rounded-md text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white border border-blue-600" aria-expanded="false" aria-controls="newMemoSection">New Memo</button>
        <button id="reloadBtn" class="px-3 py-1.5 rounded-md text-sm font-medium bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700">Reload</button>
        <button id="themeToggle" class="px-3 py-1.5 rounded-md text-sm font-medium bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700" aria-label="Toggle dark mode">Dark</button>
      </div>
    </div>
  </header>

  <!-- Main container -->
  <main class="max-w-4xl mx-auto px-4 pt-6 pb-28">
    <!-- New Memo Card -->
    <section aria-labelledby="new-memo-title" id="newMemoSection" class="mb-8 hidden">
      <h2 id="new-memo-title" class="sr-only">New Memo</h2>

      <form id="memoForm" class="border border-gray-200 dark:border-gray-800 rounded-xl p-4 md:p-6 bg-white dark:bg-gray-950 shadow-sm" novalidate>
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm text-gray-600 dark:text-gray-400">Drag & drop images below, or click the area to select</p>
          <span id="uploadHint" class="text-xs text-gray-500">Max 10 images</span>
        </div>

        <!-- Dropzone -->
        <div id="dropzone" tabindex="0" role="button" aria-label="Drop files here" class="group rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700 bg-gray-50/60 dark:bg-gray-800/40 hover:bg-gray-100/60 dark:hover:bg-gray-800/60 transition-colors cursor-pointer">
          <div class="px-4 py-8 text-center">
            <div class="mx-auto mb-2 w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6H16a4 4 0 010 8h-1m-4-4v12m0 0l-3-3m3 3l3-3" /></svg>
            </div>
            <p class="text-sm"><span class="font-medium text-blue-600 dark:text-blue-300">Upload images</span> or drag and drop</p>
            <p class="text-xs text-gray-500">PNG, JPG, or WEBP</p>
          </div>
          <input type="file" name="images" id="images" multiple class="visually-hidden" aria-hidden="true" />
        </div>

        <!-- Selected previews -->
        <div id="previews" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3"></div>

        <!-- Comment -->
        <label for="comment" class="block mt-4 mb-1 text-sm font-medium">Comment</label>
        <textarea name="comment" id="comment" required class="w-full h-28 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Write your comment..."></textarea>

        <!-- Actions and status -->
        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="flex items-center gap-3 text-sm">
            <span id="statusText" class="text-gray-500"></span>
          </div>
          <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M2.94 10.94l-.88 3.52a1 1 0 001.22 1.22l3.52-.88 8.49-8.49a1.5 1.5 0 00-2.12-2.12l-8.49 8.49z"/><path d="M12.59 5.41L14 6.83"/></svg>
            Add Memo
          </button>
        </div>
      </form>
    </section>

    <!-- Controls -->
    <section aria-label="Memo controls" class="mb-3 flex flex-wrap items-center gap-3">
      <div class="inline-flex items-center gap-2 text-sm">
        <label for="sortSelect" class="text-gray-600 dark:text-gray-400">Sort</label>
        <select id="sortSelect" class="border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 rounded-md px-2 py-1 text-sm">
          <option value="newest" selected>Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
      </div>
      <div class="relative">
        <input id="searchInput" type="search" placeholder="Search comments..." class="w-64 max-w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
    </section>

    <!-- Memos list -->
    <section>
      <h2 class="sr-only">Memos</h2>
      <div id="memoList" class="space-y-4"></div>
      <div id="emptyState" class="hidden mt-10 text-center text-gray-500">
        <p>No memos yet.</p>
      </div>
    </section>
  </main>

  <!-- Bottom navigation include -->
  <div id="menu-include"></div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 hidden"></div>

  <script>
    // Config
    const API_URL = "/memo"; // Cloudflare Pages Function proxy with CORS

    // Elements
    const form = document.getElementById('memoForm');
    const fileInput = document.getElementById('images');
    const dropzone = document.getElementById('dropzone');
    const previews = document.getElementById('previews');
    const memoList = document.getElementById('memoList');
    const statusText = document.getElementById('statusText');
    const toast = document.getElementById('toast');
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    const newMemoSection = document.getElementById('newMemoSection');
    const newMemoToggle = document.getElementById('newMemoToggle');

    // State
    let allMemos = [];
    let selectedFiles = [];

    // Helpers
    function showToast(message, type = 'info') {
      toast.className = 'fixed bottom-24 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-sm shadow ' +
        (type === 'error' ? 'bg-red-600 text-white' : type === 'success' ? 'bg-green-600 text-white' : 'bg-gray-800 text-white');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => { toast.classList.add('hidden'); }, 2200);
    }

    function formatDate(d) {
      const dt = new Date(d);
      if (isNaN(dt)) return '';
      return dt.toLocaleString();
    }

    function renderMemos(list) {
      memoList.innerHTML = '';
      if (!list || list.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      }
      document.getElementById('emptyState').classList.add('hidden');

      list.forEach(m => {
        const card = document.createElement('article');
        card.className = 'rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 p-4 shadow-sm';
        // Images
        const imagesHTML = (m.images || []).map((url, i) => (
          `<img src="${url}" loading="lazy" alt="Memo image ${i+1}" class="w-full h-28 object-cover rounded-md" />`
        )).join('');
        const grid = imagesHTML ? `<div class=\"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 mb-2\">${imagesHTML}</div>` : '';
        // Content
        card.innerHTML = `
          ${grid}
          <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
            <span>${formatDate(m.date)}</span>
            ${m.pinned ? '<span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200">Pinned</span>' : ''}
          </div>
          <p class="text-sm whitespace-pre-wrap">${m.comment || ''}</p>
          <div class="mt-3 flex gap-2">
            <button class="px-3 py-1.5 rounded-md text-sm border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800" data-action="edit" data-id="${m.id}">Edit</button>
            <button class="px-3 py-1.5 rounded-md text-sm border border-red-200 text-red-600 hover:bg-red-50 dark:border-red-800 dark:hover:bg-red-900/20" data-action="delete" data-id="${m.id}">Delete</button>
          </div>
        `;
        memoList.appendChild(card);
      });
    }

    function applyFilters() {
      let list = [...allMemos];
      const q = (searchInput.value || '').trim().toLowerCase();
      if (q) list = list.filter(m => (m.comment || '').toLowerCase().includes(q));
      const sort = sortSelect.value;
      list.sort((a,b) => {
        const da = new Date(a.date).getTime();
        const db = new Date(b.date).getTime();
        return sort === 'oldest' ? da - db : db - da;
      });
      // Pinned to top when available
      list.sort((a,b) => (b.pinned === true) - (a.pinned === true));
      renderMemos(list);
    }

    async function loadMemos() {
      statusText.textContent = 'Loading...';
      try {
        const res = await fetch(API_URL + '?action=list', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        // Normalize shape
        allMemos = (Array.isArray(data) ? data : []).map(m => ({
          id: m.id,
          date: m.date,
          comment: m.comment,
          images: m.images || [],
          pinned: m.pinned === true || m.pinned === 'true' // backend update later
        }));
        applyFilters();
        statusText.textContent = '';
      } catch (err) {
        console.error(err);
        statusText.textContent = 'Failed to load memos';
        showToast('Could not load memos. Check network/API URL.', 'error');
      }
    }

    function clearSelection() {
      selectedFiles = [];
      fileInput.value = '';
      previews.innerHTML = '';
    }

    function renderPreviews() {
      previews.innerHTML = '';
      selectedFiles.forEach((file, idx) => {
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div');
        wrap.className = 'relative group';
        wrap.innerHTML = `
          <img src="${url}" alt="preview ${idx+1}" class="w-full h-24 object-cover rounded-md border border-gray-200 dark:border-gray-800" />
          <button type="button" class="absolute top-1 right-1 hidden group-hover:flex items-center justify-center w-6 h-6 rounded-full bg-black/60 text-white text-xs" aria-label="Remove image" data-remove="${idx}">×</button>
        `;
        previews.appendChild(wrap);
      });
    }

    // Drag & drop events
    ['dragenter','dragover'].forEach(ev => {
      form.addEventListener(ev, e => {
        e.preventDefault();
        const isDark = document.documentElement.classList.contains('dark');
        dropzone.classList.add(isDark ? 'drag-over-dark' : 'drag-over');
      });
    });
    ;['dragleave','drop'].forEach(ev => {
      form.addEventListener(ev, e => {
        e.preventDefault();
        dropzone.classList.remove('drag-over', 'drag-over-dark');
      });
    });
    form.addEventListener('drop', e => {
      const dt = e.dataTransfer;
      const files = Array.from(dt.files).slice(0, 10);
      selectedFiles = files;
      renderPreviews();
    });

    // Click to open selector (while not clicking interactive elements)
    dropzone.addEventListener('click', (e) => {
      fileInput.click();
    });

    fileInput.addEventListener('change', () => {
      const files = Array.from(fileInput.files).slice(0, 10);
      selectedFiles = files;
      renderPreviews();
    });

    // Remove preview image
    previews.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-remove]');
      if (!btn) return;
      const idx = Number(btn.getAttribute('data-remove'));
      selectedFiles.splice(idx, 1);
      renderPreviews();
    });

    // Toggle New Memo section visibility
    if (newMemoToggle && newMemoSection) {
      newMemoToggle.addEventListener('click', () => {
        const nowHidden = newMemoSection.classList.toggle('hidden');
        const expanded = !nowHidden;
        newMemoToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        if (expanded) {
          newMemoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    // Submit handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const comment = document.getElementById('comment').value.trim();
      if (!comment) {
        showToast('Comment is required', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('action', 'add');
      formData.append('comment', comment);
      selectedFiles.forEach((f, i) => formData.append('file' + i, f));

      statusText.textContent = 'Uploading...';
      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Upload failed');
        // Reset
        document.getElementById('comment').value = '';
        clearSelection();
        showToast('Memo added', 'success');
        await loadMemos();
        // Auto-close the New Memo section after successful submit
        if (newMemoSection && newMemoToggle) {
          newMemoSection.classList.add('hidden');
          newMemoToggle.setAttribute('aria-expanded', 'false');
        }
      } catch (err) {
        console.error(err);
        showToast('Failed to add memo', 'error');
      } finally {
        statusText.textContent = '';
      }
    });

    // Edit memo
    async function editMemo(id) {
      const password = prompt('Enter password to edit:');
      if (!password) return;
      const comment = prompt('New comment:');
      if (comment === null) return;
      const pinned = confirm('Pin this memo to top?');
      const formData = new FormData();
      formData.append('action', 'edit');
      formData.append('id', id);
      formData.append('comment', comment);
      formData.append('password', password);
      formData.append('pinned', pinned ? 'true' : 'false');
      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Edit failed');
        showToast('Memo updated', 'success');
        await loadMemos();
      } catch (err) {
        console.error(err);
        showToast('Failed to update memo', 'error');
      }
    }

    // Delete memo
    async function deleteMemo(id) {
      const password = prompt('Enter password to delete:');
      if (!password) return;
      if (!confirm('Delete this memo?')) return;
      const formData = new FormData();
      formData.append('action', 'delete');
      formData.append('id', id);
      formData.append('password', password);
      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('Delete failed');
        showToast('Memo deleted', 'success');
        await loadMemos();
      } catch (err) {
        console.error(err);
        showToast('Failed to delete memo', 'error');
      }
    }

    // Action delegation for memo buttons
    memoList.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (action === 'edit') editMemo(id);
      if (action === 'delete') deleteMemo(id);
    });

    // Sorting and search
    sortSelect.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);

    // Reload button
    document.getElementById('reloadBtn').addEventListener('click', loadMemos);

    // Theme toggle (persist in localStorage)
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(theme) {
      const root = document.documentElement;
      if (theme === 'dark') {
        root.classList.add('dark');
        themeToggle.textContent = 'Light';
      } else {
        root.classList.remove('dark');
        themeToggle.textContent = 'Dark';
      }
    }
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle.addEventListener('click', () => {
      const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });

    // Load bottom menu include
    async function loadMenuInclude() {
      try {
        const res = await fetch('/includes/menu.html', { cache: 'no-store' });
        if (!res.ok) return; // Non-blocking
        const html = await res.text();
        document.getElementById('menu-include').innerHTML = html;
      } catch (err) {
        console.warn('Menu include failed to load');
      }
    }

    // Init
    loadMenuInclude();
    loadMemos();
  </script>

  <!--
  CHANGELOG
  [2025-10-17] v1.4.3 – Switched API_URL to /memo Cloudflare proxy with CORS.
  Reason: Bypass browser CORS with server-side proxy on Cloudflare Pages.
  Impact: Frontend fetch succeeds without CORS; backend URL configurable via env.
  Model: GPT-5
  [2025-10-17] v1.4.2 – Fixed malformed API_URL causing CORS/fetch failure.
  Reason: URL mistakenly concatenated two endpoints; requests failed.
  Impact: Memos load and submit properly when backend allows CORS.
  Model: GPT-5
  [2025-10-17] v1.4.1 – Hide New Memo by default; add toggle button and ARIA.
  Reason: Requested UX to open the form only on demand.
  Impact: Cleaner initial view; accessible toggle; auto-close after submit.
  Model: GPT-5
  [2025-10-17] v1.4.0 – Rebuilt UI with Tailwind, dark mode, previews, menu include.
  Reason: Improve UX, accessibility, and modern design; prepare for pinned support.
  Impact: Cleaner UI, better performance and accessibility; ready for backend enhancements.
  Model: GPT-5
  -->
</body>
</html>